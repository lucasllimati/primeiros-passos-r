## 

\begin{center}
\LARGE{\textcolor{red}{Comércio Varejista Ampliado: Atividades}}
\end{center}

```{r, echo=F, eval=T, results='asis', fig.width=8, fig.height=4, fig.align='center', out.width="1\\linewidth", warning=FALSE, message=FALSE, size='tiny'}

### Coletar os dados das atividades do comércio ampliado
## Atividades - Ajuste Sazonal - Volume
ativ_vol_sa = get_sidra(api='/t/3419/n1/all/v/1186/p/all/c11046/40312/c85/all/d/v1186%201') %>%
  mutate(date = parse_date(`Mês (Código)`, format = '%Y%m')) %>%
  select(date, Atividades, Valor) %>%
  spread(Atividades, Valor) %>%
  select(- "Eletrodomésticos", - "Móveis") %>%
  rename(`Artigos farmacêuticos` = "Artigos farmacêuticos, médicos, ortopédicos, de perfumaria e cosméticos") %>%
  rename(`Materiais para escritório` = "Equipamentos e materiais para escritório, informática e comunicação") %>%
  rename(`Hipermercados, supermercados e outros` = "Hipermercados, supermercados, produtos alimentícios, bebidas e fumo") %>%
  tibble::as_tibble() 

## Atividades - Sem Ajuste Sazonal - Volume
ativ_vol = get_sidra(api='/t/3419/n1/all/v/1186/p/all/c11046/40311/c85/all/d/v1186%201') %>%
  mutate(date = parse_date(`Mês (Código)`, format = '%Y%m')) %>%
  select(date, Atividades, Valor) %>%
  spread(Atividades, Valor) %>%
  rename(`Artigos farmacêuticos` = "Artigos farmacêuticos, médicos, ortopédicos, de perfumaria e cosméticos") %>%
  rename(`Materiais para escritório` = "Equipamentos e materiais para escritório, informática e comunicação") %>%
  rename(`Hipermercados, supermercados e outros` = "Hipermercados, supermercados, produtos alimentícios, bebidas e fumo") %>%
  tibble::as_tibble() 
  
## Atividades - Ajuste Sazonal - Receita
ativ_rec_sa = get_sidra(api='/t/3419/n1/all/v/1190/p/all/c11046/40312/c85/all/d/v1190%201') %>%
  mutate(date = parse_date(`Mês (Código)`, format = '%Y%m')) %>%
  select(date, Atividades, Valor) %>%
  spread(Atividades, Valor) %>%
  select(- "Eletrodomésticos", - "Móveis") %>%
  rename(`Artigos farmacêuticos` = "Artigos farmacêuticos, médicos, ortopédicos, de perfumaria e cosméticos") %>%
  rename(`Materiais para escritório` = "Equipamentos e materiais para escritório, informática e comunicação") %>%
  rename(`Hipermercados, supermercados e outros` = "Hipermercados, supermercados, produtos alimentícios, bebidas e fumo") %>%
  tibble::as_tibble() 
  
## Atividades - Sem Ajuste Sazonal - Receita
ativ_rec = get_sidra(api='/t/3419/n1/all/v/1190/p/all/c11046/40311/c85/all/d/v1190%201') %>%
  mutate(date = parse_date(`Mês (Código)`, format = '%Y%m')) %>%
  select(date, Atividades, Valor) %>%
  spread(Atividades, Valor) %>%
  rename(`Artigos farmacêuticos` = "Artigos farmacêuticos, médicos, ortopédicos, de perfumaria e cosméticos") %>%
  rename(`Materiais para escritório` = "Equipamentos e materiais para escritório, informática e comunicação") %>%
  rename(`Hipermercados, supermercados e outros` = "Hipermercados, supermercados, produtos alimentícios, bebidas e fumo") %>%
  tibble::as_tibble() 


```

```{r, echo=F, eval=T, results='asis', fig.width=8, fig.height=4, fig.align='center', out.width="1\\linewidth", warning=FALSE, message=FALSE, size='tiny'}

#### Criar métricas ####

### Variação na Margem - Volume
margem_vol = ts(ativ_vol_sa[,-1], start=c(year(ativ_vol_sa$date[1]),
                                          month(ativ_vol_sa$date[1])),
                freq=12)
margem_vol = (margem_vol/stats::lag(margem_vol,-1)-1)*100 
colnames(margem_vol) <- colnames(ativ_vol_sa[,-1])
## Transformar wide para long
margem_vol_long = tk_tbl(margem_vol, preserve_index = TRUE, 
                         rename_index = 'date') %>%
  gather(variavel, valor, -date)

### Variação na Margem - Receita
margem_rec = ts(ativ_rec_sa[,-1], start=c(year(ativ_rec_sa$date[1]),
                                          month(ativ_rec_sa$date[1])),
                freq=12)
margem_rec = (margem_rec/stats::lag(margem_rec,-1)-1)*100 
colnames(margem_rec) <- colnames(ativ_rec_sa[,-1])
## Transformar wide para long
margem_rec_long = tk_tbl(margem_rec, preserve_index = TRUE, 
                         rename_index = 'date') %>%
  gather(variavel, valor, -date)

### Variação Interanual - Volume
inter_vol = ts(ativ_vol[,-1], start=c(year(ativ_vol$date[1]),
                                      month(ativ_vol$date[1])), 
               freq=12)
inter_vol = (inter_vol/stats::lag(inter_vol,-12)-1)*100 
colnames(inter_vol) <- colnames(ativ_vol[,-1])
## Transformar wide para long
inter_vol_long = tk_tbl(inter_vol, preserve_index = TRUE, 
                        rename_index ='date') %>%
  gather(variavel, valor, -date)

### Variação Interanual - Receita
inter_rec = ts(ativ_rec[,-1], start=c(year(ativ_rec$date[1]),
                                      month(ativ_rec$date[1])), 
               freq=12)
inter_rec = (inter_rec/stats::lag(inter_rec,-12)-1)*100 
colnames(inter_rec) <- colnames(ativ_rec[,-1])
## Transformar wide para long
inter_rec_long = tk_tbl(inter_rec, preserve_index = TRUE, 
                        rename_index ='date') %>%
  gather(variavel, valor, -date)

### Variação acumulada em quatro trimestres - Volume
anual_vol = acum_i(ts(ativ_vol[,-1], start=c(year(ativ_vol$date[1]),
                                      month(ativ_vol$date[1])), 
               freq=12),12) %>%
  as_tibble() %>%
  mutate(date = ativ_vol$date) %>%
  select(date, everything()) 

anual_vol_long =
  anual_vol %>%
  gather(variavel, valor, -date)

### Variação acumulada em quatro trimestres - Receita
anual_rec = acum_i(ts(ativ_rec[,-1], start=c(year(ativ_rec$date[1]),
                                      month(ativ_rec$date[1])), 
               freq=12),12) %>%
  as_tibble() %>%
  mutate(date = ativ_rec$date) %>%
  select(date, everything())

anual_rec_long = 
  anual_rec %>%
  gather(variavel, valor, -date)


```

## Resumo dos dados das Atividades

```{r, echo=F, eval=T, results='asis', fig.width=8, fig.height=4, fig.align='center', out.width="1\\linewidth", warning=FALSE, message=FALSE, size='tiny'}

margem_vol %>%
  as_tibble() %>%
  tail(1) %>%
  t() %>%
  kable(digits = 2,
        align='c',
        caption='Variações marginais de Volume') 


```

## Resumo dos dados das Atividades

```{r, echo=F, eval=T, results='asis', fig.width=8, fig.height=4, fig.align='center', out.width="1\\linewidth", warning=FALSE, message=FALSE, size='tiny'}

margem_rec %>%
  as_tibble() %>%
  tail(1) %>%
  t() %>%
  kable(digits = 2,
        align='c',
        caption='Variações marginais de Receita') 


```

## Resumo dos dados das Atividades

```{r, echo=F, eval=T, results='asis', fig.width=8, fig.height=4, fig.align='center', out.width="1\\linewidth", warning=FALSE, message=FALSE, size='tiny'}

inter_vol %>%
  as_tibble() %>%
  tail(1) %>%
  t() %>%
  kable(digits = 2,
        align='c',
        caption='Variações interanuais de Volume') 


```

## Resumo dos dados das Atividades

```{r, echo=F, eval=T, results='asis', fig.width=8, fig.height=4, fig.align='center', out.width="1\\linewidth", warning=FALSE, message=FALSE, size='tiny'}

inter_rec %>%
  as_tibble() %>%
  tail(1) %>%
  t() %>%
  kable(digits = 2,
        align='c',
        caption='Variações interanuais de Receita') 


```

## Resumo dos dados das Atividades

```{r, echo=F, eval=T, results='asis', fig.width=8, fig.height=4, fig.align='center', out.width="1\\linewidth", warning=FALSE, message=FALSE, size='tiny'}

anual_vol %>%
  select(-date) %>%
  tail(1) %>%
  t() %>%
  kable(digits = 2,
        align='c',
        caption='Variações acumuladas em 12 meses de Volume') 


```

## Resumo dos dados das Atividades

```{r, echo=F, eval=T, results='asis', fig.width=8, fig.height=4, fig.align='center', out.width="1\\linewidth", warning=FALSE, message=FALSE, size='tiny'}

anual_rec %>%
  select(-date) %>%
  tail(1) %>%
  t() %>%
  kable(digits = 2,
        align='c',
        caption='Variações acumuladas em 12 meses de Receita') 


```

## Visualização dos dados das Atividades

```{r, echo=F, eval=T, results='asis', fig.width=8, fig.height=4, fig.align='center', out.width="1\\linewidth", warning=FALSE, message=FALSE, size='tiny'}

margem_vol_long %>%
  filter(date > "2014-01-01", 
         variavel %in% unique(margem_vol_long$variavel)[-c(1,4)]) %>%
  ggplot(aes(x=date, y=valor, colour=variavel))+
  geom_line(size=.8)+
  geom_hline(yintercept=0, colour='black', linetype='dashed')+
  facet_wrap(~variavel, scales='free')+
  theme(legend.position = 'none',
        axis.text.x = element_text(size=8),
        strip.text = element_text(size=7, face='bold'))+
  scale_x_yearmon(breaks = pretty_breaks(n=4),
                  format="%Y")+
  labs(x='', y='',
       title='Variação marginal do Volume das Atividades do Comércio Varejista (%)',
       caption='Fonte: analisemacro.com.br com dados do IBGE')

```

## Visualização dos dados das Atividades

```{r, echo=F, eval=T, results='asis', fig.width=8, fig.height=4, fig.align='center', out.width="1\\linewidth", warning=FALSE, message=FALSE, size='tiny'}

margem_vol_long %>%
  filter(date > "2014-01-01", 
         variavel %in% unique(margem_vol_long$variavel)[c(1,4)]) %>%
  ggplot(aes(x=date, y=valor, colour=variavel))+
  geom_line(size=.8)+
  geom_hline(yintercept=0, colour='black', linetype='dashed')+
  facet_wrap(~variavel, scales='free')+
  theme(legend.position = 'none',
        axis.text.x = element_text(size=8),
        strip.text = element_text(size=10, face='bold'))+
  scale_x_yearmon(breaks = pretty_breaks(n=4),
                  format="%Y")+
  labs(x='', y='',
       title='Variação marginal do Volume das Atividades do Comércio Varejista (%)',
       caption='Fonte: analisemacro.com.br com dados do IBGE')

```

## Visualização dos dados das Atividades

```{r, echo=F, eval=T, results='asis', fig.width=8, fig.height=4, fig.align='center', out.width="1\\linewidth", warning=FALSE, message=FALSE, size='tiny'}

margem_rec_long %>%
  filter(date > "2014-01-01", 
         variavel %in% unique(margem_vol_long$variavel)[-c(1,4)]) %>%
  ggplot(aes(x=date, y=valor, colour=variavel))+
  geom_line(size=.8)+
  geom_hline(yintercept=0, colour='black', linetype='dashed')+
  facet_wrap(~variavel, scales='free')+
  theme(legend.position = 'none',
        axis.text.x = element_text(size=8),
        strip.text = element_text(size=7, face='bold'))+
  scale_x_yearmon(breaks = pretty_breaks(n=4),
                  format="%Y")+
  labs(x='', y='',
       title='Variação marginal da Receita das Atividades do Comércio Varejista (%)',
       caption='Fonte: analisemacro.com.br com dados do IBGE')

```

## Visualização dos dados das Atividades

```{r, echo=F, eval=T, results='asis', fig.width=8, fig.height=4, fig.align='center', out.width="1\\linewidth", warning=FALSE, message=FALSE, size='tiny'}

margem_rec_long %>%
  filter(date > "2014-01-01", 
         variavel %in% unique(margem_vol_long$variavel)[c(1,4)]) %>%
  ggplot(aes(x=date, y=valor, colour=variavel))+
  geom_line(size=.8)+
  geom_hline(yintercept=0, colour='black', linetype='dashed')+
  facet_wrap(~variavel, scales='free')+
  theme(legend.position = 'none',
        axis.text.x = element_text(size=8),
        strip.text = element_text(size=10, face='bold'))+
  scale_x_yearmon(breaks = pretty_breaks(n=4),
                  format="%Y")+
  labs(x='', y='',
       title='Variação marginal da Receita das Atividades do Comércio Varejista (%)',
       caption='Fonte: analisemacro.com.br com dados do IBGE')

```

## Visualização dos dados das Atividades

```{r, echo=F, eval=T, results='asis', fig.width=8, fig.height=4, fig.align='center', out.width="1\\linewidth", warning=FALSE, message=FALSE, size='tiny'}

inter_vol_long %>%
  filter(date > "2014-01-01", 
         variavel %in% unique(margem_vol_long$variavel)[-c(1,4)]) %>%
  ggplot(aes(x=date, y=valor, colour=variavel))+
  geom_line(size=.8)+
  geom_hline(yintercept=0, colour='black', linetype='dashed')+
  facet_wrap(~variavel, scales='free')+
  theme(legend.position = 'none',
        axis.text.x = element_text(size=8),
        strip.text = element_text(size=7, face='bold'))+
  scale_x_yearmon(breaks = pretty_breaks(n=4),
                  format="%Y")+
  labs(x='', y='',
       title='Variação interanual do Volume das Atividades do Comércio Varejista (%)',
       caption='Fonte: analisemacro.com.br com dados do IBGE')

```

## Visualização dos dados das Atividades

```{r, echo=F, eval=T, results='asis', fig.width=8, fig.height=4, fig.align='center', out.width="1\\linewidth", warning=FALSE, message=FALSE, size='tiny'}

inter_vol_long %>%
  filter(date > "2014-01-01", 
         variavel %in% unique(margem_vol_long$variavel)[c(1,4)]) %>%
  ggplot(aes(x=date, y=valor, colour=variavel))+
  geom_line(size=.8)+
  geom_hline(yintercept=0, colour='black', linetype='dashed')+
  facet_wrap(~variavel, scales='free')+
  theme(legend.position = 'none',
        axis.text.x = element_text(size=8),
        strip.text = element_text(size=10, face='bold'))+
  scale_x_yearmon(breaks = pretty_breaks(n=4),
                  format="%Y")+
  labs(x='', y='',
       title='Variação interanual do Volume das Atividades do Comércio Varejista (%)',
       caption='Fonte: analisemacro.com.br com dados do IBGE')

```

## Visualização dos dados das Atividades

```{r, echo=F, eval=T, results='asis', fig.width=8, fig.height=4, fig.align='center', out.width="1\\linewidth", warning=FALSE, message=FALSE, size='tiny'}

inter_rec_long %>%
  filter(date > "2014-01-01", 
         variavel %in% unique(margem_vol_long$variavel)[-c(1,4)]) %>%
  ggplot(aes(x=date, y=valor, colour=variavel))+
  geom_line(size=.8)+
  geom_hline(yintercept=0, colour='black', linetype='dashed')+
  facet_wrap(~variavel, scales='free')+
  theme(legend.position = 'none',
        axis.text.x = element_text(size=8),
        strip.text = element_text(size=7, face='bold'))+
  scale_x_yearmon(breaks = pretty_breaks(n=4),
                  format="%Y")+
  labs(x='', y='',
       title='Variação interanual da Receita das Atividades do Comércio Varejista (%)',
       caption='Fonte: analisemacro.com.br com dados do IBGE')

```

## Visualização dos dados das Atividades

```{r, echo=F, eval=T, results='asis', fig.width=8, fig.height=4, fig.align='center', out.width="1\\linewidth", warning=FALSE, message=FALSE, size='tiny'}

inter_rec_long %>%
  filter(date > "2014-01-01", 
         variavel %in% unique(margem_vol_long$variavel)[c(1,4)]) %>%
  ggplot(aes(x=date, y=valor, colour=variavel))+
  geom_line(size=.8)+
  geom_hline(yintercept=0, colour='black', linetype='dashed')+
  facet_wrap(~variavel, scales='free')+
  theme(legend.position = 'none',
        axis.text.x = element_text(size=8),
        strip.text = element_text(size=10, face='bold'))+
  scale_x_yearmon(breaks = pretty_breaks(n=4),
                  format="%Y")+
  labs(x='', y='',
       title='Variação interanual da Receita das Atividades do Comércio Varejista (%)',
       caption='Fonte: analisemacro.com.br com dados do IBGE')

```

## Visualização dos dados das Atividades

```{r, echo=F, eval=T, results='asis', fig.width=8, fig.height=4, fig.align='center', out.width="1\\linewidth", warning=FALSE, message=FALSE, size='tiny'}

anual_vol_long %>%
  filter(date > "2014-01-01",
         variavel %in% unique(margem_vol_long$variavel)[-c(1,4)]) %>%
  ggplot(aes(x=date, y=valor, colour=variavel))+
  geom_line(size=.8)+
  geom_hline(yintercept=0, colour='black', linetype='dashed')+
  facet_wrap(~variavel, scales='free')+
  theme(legend.position = 'none',
        axis.text.x = element_text(size=8),
        strip.text = element_text(size=7, face='bold'),
        plot.title = element_text(size=10, face='bold'))+
  scale_x_date(breaks = pretty_breaks(n=4),
               labels = date_format("%Y"))+
  labs(x='', y='',
       title='Variação acumulada em 12 meses do Volume das Atividades do Comércio Varejista (%)',
       caption='Fonte: analisemacro.com.br com dados do IBGE')

```

## Visualização dos dados das Atividades

```{r, echo=F, eval=T, results='asis', fig.width=8, fig.height=4, fig.align='center', out.width="1\\linewidth", warning=FALSE, message=FALSE, size='tiny'}

anual_vol_long %>%
  filter(date > "2014-01-01",
         variavel %in% unique(margem_vol_long$variavel)[c(1,4)]) %>%
  ggplot(aes(x=date, y=valor, colour=variavel))+
  geom_line(size=.8)+
  geom_hline(yintercept=0, colour='black', linetype='dashed')+
  facet_wrap(~variavel, scales='free')+
  theme(legend.position = 'none',
        axis.text.x = element_text(size=8),
        strip.text = element_text(size=10, face='bold'),
        plot.title = element_text(size=10, face='bold'))+
  scale_x_date(breaks = pretty_breaks(n=4),
               labels = date_format("%Y"))+
  labs(x='', y='',
       title='Variação acumulada em 12 meses do Volume das Atividades do Comércio Varejista (%)',
       caption='Fonte: analisemacro.com.br com dados do IBGE')

```
